#!/bin/bash -vx

DESTDIR=$(pwd)/bld

mkdir -p $DESTDIR

#export 
#export LDFLAGS="-static -L$DESTDIR/lib"

(cd e2fsprogs-libs; \
    CFLAGS="-I$DESTDIR/include" \
    LDFLAGS="-static -L$DESTDIR/lib" \
    ./configure --prefix=/; make ; make DESTDIR=$DESTDIR install)

(cd attr; \
    CFLAGS="-I$DESTDIR/include" \
    LDFLAGS="-static -L$DESTDIR/lib" \
    ./configure --prefix=$DESTDIR; \
    make LLDFLAGS=-all-static ; \
    make install-dev ; make install)

(cd acl; \
    CFLAGS="-I$DESTDIR/include" \
    LDFLAGS="-static -L$DESTDIR/lib" \
    ./configure --prefix=$DESTDIR; \
    make LLDFLAGS=-all-static; \
    make install-dev; \
    make install)

(cd libaio; make prefix=$DESTDIR install)

(cd xfsprogs-dev; make realclean ; make configure ; \
    CFLAGS="-I$DESTDIR/include" \
    LDFLAGS="-static -L$DESTDIR/lib" \
    LIBS=-lpthread \
    ./configure --prefix=/; \
    make LLDFLAGS=-all-static BUILD_VERBOSE=1; \
    DIST_ROOT=$DESTDIR make install; \
    DIST_ROOT=$DESTDIR make install-dev)

(cd dmapi; \
    CFLAGS="-I$DESTDIR/include" \
    LDFLAGS="-static -L$DESTDIR/lib" \
    ./configure --prefix=$DESTDIR; \
    LIBTOOL="/usr/bin/libtool --tag=CC" make LLDFLAGS=-all-static; \
    make install-dev; make install)

find . -name \*.la | xargs rm -f      # Die, libtool, die!!!!
cp $DESTDIR/include/xfs/dmapi.h $DESTDIR/include

(cd xfstests-dev; \
    CFLAGS="-I$DESTDIR/include  -fno-stack-protector"
    LDFLAGS="-static -L$DESTDIR/lib" \
    LIBS=-lpthread \
    ./configure ; \
    make LLDFLAGS=-all-static BUILD_VERBOSE=1)

