#!/bin/bash

if test -f config.custom ; then
	. config.custom
else
	. config
fi

setup_repo()
{
    local repo_name="$1"
    local repo_url_variable="$2"
    local repo_url="${!2}"
    local commit_variable="$3"
    local commit="${!3}"
    local required="$4"

    # Clone the repository if needed.
    if [ ! -d "$repo_name" ]; then
	if [ -z "$repo_url" ]; then
	    if ! $required; then
		return
	    fi
	    echo 1>&2 "$repo_url_variable not set; check your config file!"
	    exit 1
	fi

	echo
	if ! git clone "$repo_url" "$repo_name"; then
	    echo 1>&2 "Failed to clone $repo_name from $repo_url"
	    exit 1
	fi

	# If a specific commit was specified, check it out.
	if [ -n "$commit" ]; then
	    ( cd "$repo_name";
	      git branch xfstests-bld "$commit";
	      git checkout xfstests-bld;
	    )
	fi
    fi
}

# required repositories
setup_repo fio			FIO_GIT		FIO_COMMIT		true
setup_repo quota		QUOTA_GIT	QUOTA_COMMIT		true
setup_repo xfsprogs-dev		XFSPROGS_GIT	XFSPROGS_COMMIT		true
setup_repo xfstests-dev		XFSTESTS_GIT	XFSTESTS_COMMIT		true

# optional repositories
setup_repo stress-ng		STRESS_NG_GIT	STRESS_NG_COMMIT	false

# Make sure acl doesn't try regenerate these files because of the
# vagrancies of the timestamps when they were checked out
touch acl/aclocal.m4 acl/configure acl/Makefile.in
