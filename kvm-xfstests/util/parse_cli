FSTESTCFG=all
SNAPSHOT=",snapshot=on"
DO_AEX="yes"

while [ "$1" != "" ]; do
  case $1 in
    -a)
      DO_AEX=""
      ;;
    -c)	shift
      FSTESTCFG=$1
      ;;
    -C) shift
      FSTESTOPT="$FSTESTOPT,count,$1"
      ;;
    -m) shift
      MNTOPTS=$1
      ;;
    -r) shift
      MEM=$1
      ;;
    -g) shift
      FSTESTSET="$FSTESTSET,-g,$1"
      ;;
    -h|--help|help)
      echo "Usage: $0 [<OPTIONS>] smoke|full"
      echo "Usage: $0 [<OPTIONS>] <test> ..."
      echo "Usage: $0 [<OPTIONS>] -g <group> ..."
      echo "Usage: $0 shell|maint"
      echo " "
      echo "Common options are:"
      echo "	-a		- Disable auto-exclude; run all tests"
      echo "	-c config	- Specify a file system configuration"
      echo "	-C count	- Run the specified tests multiple times"
      echo "	-m mountopts	- Append mount options to fs config"
      echo "	-n nr_cpus	- Specify the number of cpu's"
      echo "	-N		- Enable networking (requires root)"
      echo "	-r ram		- Specify memory to be used in megabytes"
      echo "	-X test		- Exclude test from running"
      echo "	--kernel file	- Boot the specified kernel"
      echo "	--no-log	- Don't save the log file for this run"
      echo " "
      echo "Common file system configurations are:"
      echo "	4k 1k ext3 nojournal ext3conv metacsum dioread_nolock "
      echo "	data_journal bigalloc bigalloc_1k inline"
      echo " "
      exit 1
      ;;
    -n) shift
      NR_CPU=$1
      ;;
    -v)
      if test "$V" = "1" ; then
      	  QUIET=""
	  V=2
      else
          QUIET="systemd.show_status=auto systemd.log_level=crit"
	  V=1
      fi
      ;;
    -N)
      DO_NET=yes
      ;;
    -X) shift
	if test -n "$FSTESTEXC" ; then
	    FSTESTEXC="$FSTESTEXC,$1"
	else
	    FSTESTEXC="$1"
	fi
	;;
    --no-log)
      SKIP_LOG=yes
      ;;
    --log)
      SKIP_LOG=no
      ;;
    --kernel) shift
      KERNEL=$1
      ;;
    smoke)
      FSTESTCFG=4k
      FSTESTSET="$FSTESTSET,-g,quick"
      ;;
    quick)
      FSTESTSET="$FSTESTSET,-g,quick"
      ;;
    full)
      FSTESTSET="$FSTESTSET,-g,auto"
      ;;
    shell)
      ARG="maint"
      ;;
    maint)
      ARG="maint"
      EPH="-root_ephemeral=no"
      SNAPSHOT=""
      ;;
    ver)
      ARG="cmd=ver"
      ;;
    *)
      FSTESTSET="$FSTESTSET,$1"
      ;;
  esac
  shift
done

if test "$ARG" = maint -a -z "$SKIP_LOG" ; then
  SKIP_LOG=yes
fi

if test "$ARG" = "cmd=ver" -a -z "$SKIP_LOG" ; then
  SKIP_LOG=yes
fi

if test "$DO_AEX" = yes ; then
    FSTESTOPT="$FSTESTOPT,aex"
fi

FSTESTOPT=$(echo $FSTESTOPT | sed -e 's/^,//')

if test "$SKIP_LOG" = no ; then
   unset SKIP_LOG
fi

if test -n "$ARG" ; then
  :
elif test -n "$FSTESTSET"; then
     FSTESTSET=$(echo $FSTESTSET | sed -e 's/^,//')
     ARG="fstestcfg=$FSTESTCFG fstestset=$FSTESTSET fstestopt=$FSTESTOPT"
fi
if test -n "$FSTESTEXC" ; then
    ARG="$ARG fstestexc=$FSTESTEXC"
fi

if test -n "$MNTOPTS" ; then
    ARG="$ARG mount_opts=$MNTOPTS"
fi

if test -n "$TZ" ; then
    ARG="$ARG fstesttz=$TZ"
fi
