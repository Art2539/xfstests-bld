#
# Read the config files used for kvm-xfstests, gce-xfstests, etc.
#
# Shell scripts should use this file as follows:
#
# XFSTESTS_FLAVOR=kvm # (or gce, etc.)
# DIR=.
# if test -n "$KVM_XFSTESTS_DIR" # (or $GCE_XFSTESTS_DIR, etc.)
# then
#     DIR="$KVM_XFSTESTS_DIR"
# fi
#
# . "$DIR/util/get-config"

# Source the default configs
. $DIR/config.common
. $DIR/config.${XFSTESTS_FLAVOR}

# Source custom configs in ~/.config/ if present
[ -f "$HOME/.config/xfstests-common" ] && . "$HOME/.config/xfstests-common"
[ -f "$HOME/.config/${XFSTESTS_FLAVOR}-xfstests" ] && \
	. "$HOME/.config/${XFSTESTS_FLAVOR}-xfstests"

# For gce-xfstests, source the config for the active account if present
if test "$XFSTESTS_FLAVOR" = "gce" -a -z "$GCE_ACCOUNT" -a \
   -n "$(ls $DIR/config-* 2> /dev/null)"
then
   # We aren't just using GCE_ACCOUNT=$(...) to work around a performance
   # bug in gcloud.  This will hopefully be fixed soon.  :-)
   tmpfile=$(mktemp)
   gcloud config list --format='value(core.account)' core/account \
	2>/dev/null > "$tmpfile"
	GCE_ACCOUNT="$(cat $tmpfile)"
	rm "$tmpfile"
	unset tmpfile
fi

if test -n "$GCE_ACCOUNT" -a -f "$DIR/config-$GCE_ACCOUNT" ; then
    . "$DIR/config-$GCE_ACCOUNT"
elif test -f $DIR/config.custom ; then
# Else, source kvm-xfstests/config.custom if present (deprecated)
    echo -e 1>&2 "Warning: use of kvm-xfstests/config.custom is deprecated." \
	    "Move your settings\n         into ~/.config/kvm-xfstests," \
	    "~/.config/gce-xfstests,\n         ~/.config/android-xfstests," \
	    "and/or ~/.config/xfstests-common"
    . $DIR/config.custom
fi

# Source $KVM_CONFIG if present (deprecated)
if test -n "$KVM_CONFIG" -a -f "$KVM_CONFIG"; then
    echo -e 1>&2 "Warning: use of \$KVM_CONFIG is deprecated." \
	    "Move your settings into\n         ~/.config/kvm-xfstests"
    . $KVM_CONFIG
fi
